---

include:
  - local: /jobs/utils/gitlab-http-access.gitlab-ci.yml

# Use this job template to provide automated semantic version tags and gitlab releases
# for you projects
#
# Use this job template by including this file from the project
# and defining the release stage
#
# eg.:
# include:
#   - project: automation/cicd/templates
#     ref: ${latest project release version}
#     file: jobs/releasing/semantic-release.gitlab-ci.yml
# stages:
#   - release

semantic-release:
  extends:
    - .gitlab_http_access
  variables:
    SEMANTIC_RELEASE_USER: semantic-release-bot
    SEMANTIC_RELEASE_AUTH: ${SEMANTICRELEASE_TOKEN}
    GITLAB_USERNAME: ${SEMANTIC_RELEASE_USER}
    GITLAB_USERAUTH: ${SEMANTIC_RELEASE_AUTH}
  image: $REGISTRY/semantic-release
  stage: release
  script:
    - GL_TOKEN=${SEMANTICRELEASE_TOKEN} semantic-release --extends @enttribe/semantic-release-config --repository-url "${GITLAB_AUTHENTICATED_REPO_URL}"
  rules:
    - if: $CI_DEFAULT_BRANCH == $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^(alpha|beta|next|next-major)$/
    - if: $CI_COMMIT_BRANCH =~ /^(stable-)?v?([0-9]+)(\.([0-9]+|x))?\.x$/

...
